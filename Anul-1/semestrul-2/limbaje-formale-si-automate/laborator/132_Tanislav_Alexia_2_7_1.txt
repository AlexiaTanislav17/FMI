
def nfaToDfa(nfa, dfa, stariDfa, litere):
    for (stare, litera) in dfa.keys():
        if " " in stare:
            listaStare = stare.split(" ")
            stareNoua = set()
            for q in listaStare:
                if (q, litera) in nfa.keys():
                    for i in nfa[q, litera].split(" "):
                        stareNoua.add(i)
            stareNoua = sorted(stareNoua)
            stareNoua = " ".join(stareNoua)
            if stareNoua == "":
                dfa[stare, litera] = "vid"
            else:
                dfa[stare, litera] = stareNoua.strip()
                stariDfa.add(stareNoua.strip())
    check = 0
    for s in stariDfa:
        for l in litere:
            if (s, l) not in dfa.keys() and " " in s:
                check = 1
                dfa[s,l] = "vid"
    if check == 1:
        nfaToDfa(nfa, dfa, stariDfa, litere)


# citim datele pt nfa
f = open(input("fisier: "),'r')

nrStariNfa = int(f.readline())
stariNfa = f.readline().split()
nrLitereNfa = int(f.readline())
litere = f.readline().split()
stareinit = f.readline().strip()
nrStariFinaleNfa = int(f.readline())
stariFinaleNfa = f.readline().split()
nrTranzitiiNfa = int(f.readline())

nfa = {}
dfa = {}

nrStariDfa = 0
stariDfa = set()
nrLitereDfa = nrLitereNfa
nrStariFinaleDfa = 0
stariFinaleDfa = set()
nrTranzitiiDfa = 0

for i in range(nrTranzitiiNfa):
    line = f.readline().split()
    stare1 = line[0]
    litera = line[1]
    stare2 = line[2]
    if (stare1,litera) in nfa.keys():
        nfa[stare1, litera].append(stare2)
    else:
        nfa[stare1, litera] = [stare2]

# facem nfa ul
for i in nfa:
    if len(nfa[i])==1:
        nfa[i] = "".join(nfa[i])
    else:
        stareNoua = ""
        for j in nfa[i]:
            stareNoua = stareNoua + " " + j
        nfa[i] = stareNoua.strip()
    stariDfa.add(nfa[i])


#pregatim dfa ul de transformare in nfa
for litera in litere:
    for stare in stariDfa:
        if (stare, litera) not in dfa.keys():
            if (stare, litera) in nfa.keys():
                dfa[stare, litera] = nfa[stare, litera]
            elif " " in stare:
                dfa[stare, litera] = "vid"


# aici transformam din nfa in dfa
nfaToDfa(nfa, dfa, stariDfa, litere)
print("\n")
stariDfa = sorted(stariDfa)
# print(stariDfa)

i = 1
d = {}
for s in stariDfa:
    d[s] = i
    i =i+1



# aici facem restu de date necesare pt cuv dfa
for i in stariFinaleNfa:
    for s in stariDfa:
        if i in s:
            stariFinaleDfa.add(s)

stariFinaleDfa = sorted(stariFinaleDfa)
nrStariFinaleDfa = len(stariFinaleDfa)
nrStariDfa = len(stariDfa)

for (s,l) in dfa.keys():
    if dfa[s,l] != "vid":
        nrTranzitiiDfa = nrTranzitiiDfa + 1



print(nrStariDfa)
for s in d:
    print(d[s], end=" ")
print()
print(nrLitereDfa)
for l in litere:
    print(l, end=" ")
print()
print(d[stareinit])
print(nrStariFinaleDfa)
for s in stariFinaleDfa:
    print(d[s], end=" ")
print()
print(nrTranzitiiDfa)
for (s,l) in sorted(dfa):
    if dfa[s,l] != "vid":
        print(d[s], l, d[dfa[s,l]])


